<html>
<head>
<title>Da Dart Board</title>
<script>
    const GRANBOARD_UUID = "442f1570-8a00-9a28-cbe1-e1d4212d53eb";

    const SEGMENT_MAPPING = {
        // BUllsey
        "56-46-48-64": "BULL",
        "52-46-48-64": "BULL_DBL",
        // 1
        "50-46-51-64": "1_INNER",
        "50-46-52-64": "1_TRP",
        "50-46-53-64": "1_OUTER",
        "50-46-54-64": "1_DBL",
        // 2
        "57-46-49-64": "2_INNER",
        "57-46-48-64": "2_TRP",
        "57-46-50-64": "2_OUTER",
        "56-46-50-64": "2_DBL",
        // 3
        "55-46-49-64": "3_INNER",
        "55-46-48-64": "3_TRP",
        "55-46-50-64": "3_OUTER",
        "56-46-52-64": "3_DBL",
        // 4
        "48-46-49-64": "4_INNER",
        "48-46-51-64": "4_TRP",
        "48-46-53-64": "4_OUTER",
        "48-46-54-64": "4_DBL",
        // 5
        "53-46-49-64": "5_INNER",
        "53-46-50-64": "5_TRP",
        "53-46-52-64": "5_OUTER",
        "52-46-54-64": "5_DBL",
        // 6
        "49-46-48-64": "6_INNER",
        "49-46-49-64": "6_TRP",
        "49-46-51-64": "6_OUTER",
        "52-46-52-64": "6_DBL",
        // 7
        "49-49-46-49-64": "7_INNER",
        "49-49-46-50-64": "7_TRP",
        "49-49-46-52-64": "7_OUTER",
        "56-46-54-64": "7_DBL",
        // 8
        "54-46-50-64": "8_INNER",
        "54-46-52-64": "8_TRP",
        "54-46-53-64": "8_OUTER",
        "54-46-54-64": "8_DBL",
        // 9
        "57-46-51-64": "9_INNER",
        "57-46-52-64": "9_TRP",
        "57-46-53-64": "9_OUTER",
        "57-46-54-64": "9_DBL",
        // 10
        "50-46-48-64": "10_INNER",
        "50-46-49-64": "10_TRP",
        "50-46-50-64": "10_OUTER",
        "52-46-51-64": "10_DBL",
        // 11
        "55-46-51-64": "11_INNER",
        "55-46-52-64": "11_TRP",
        "55-46-53-64": "11_OUTER",
        "55-46-54-64": "11_DBL",
        // 12
        "53-46-48-64": "12_INNER",
        "53-46-51-64": "12_TRP",
        "53-46-53-64": "12_OUTER",
        "53-46-54-64": "12_DBL",
        // 13
        "48-46-48-64": "13_INNER",
        "48-46-50-64": "13_TRP",
        "48-46-52-64": "13_OUTER",
        "52-46-53-64": "13_DBL",
        // 14
        "49-48-46-51-64": "14_INNER",
        "49-48-46-52-64": "14_TRP",
        "49-48-46-53-64": "14_OUTER",
        "49-48-46-54-64": "14_DBL",
        // 15
        "51-46-48-64": "15_INNER",
        "51-46-49-64": "15_TRP",
        "51-46-50-64": "15_OUTER",
        "52-46-50-64": "15_DBL",
        // 16
        "49-49-46-48-64": "16_INNER",
        "49-49-46-51-64": "16_TRP",
        "49-49-46-53-64": "16_OUTER",
        "49-49-46-54-64": "16_DBL",
        // 17
        "49-48-46-49-64": "17_INNER",
        "49-48-46-48-64": "17_TRP",
        "49-48-46-50-64": "17_OUTER",
        "56-46-51-64": "17_DBL",
        // 18
        "49-46-50-64": "18_INNER",
        "49-46-52-64": "18_TRP",
        "49-46-53-64": "18_OUTER",
        "49-46-54-64": "18_DBL",
        // 19
        "54-46-49-64": "19_INNER",
        "54-46-48-64": "19_TRP",
        "54-46-51-64": "19_OUTER",
        "56-46-53-64": "19_DBL",
        // 20
        "51-46-51-64": "20_INNER",
        "51-46-52-64": "20_TRP",
        "51-46-53-64": "20_OUTER",
        "51-46-54-64": "20_DBL",

    }

    let boardCharacteristic = undefined;

    async function connectToDartboard() {
        if (boardCharacteristic) {
            // Unregister the previous listener
            boardCharacteristic.removeEventListener("characteristicvaluechanged", onSegmentHit);
        }

        const board = await navigator.bluetooth.requestDevice({filters:[{services: [GRANBOARD_UUID]}]});
        if (!board.gatt.connected) {
            await board.gatt.connect();
        }

        const service = await board.gatt.getPrimaryService(GRANBOARD_UUID);

        // Find the characteristic that supports the notify property. That is the one that executes when
        // a dartboard segment is hit
        boardCharacteristic = (await service.getCharacteristics()).find(characteristic => characteristic.properties.notify);

        boardCharacteristic.addEventListener("characteristicvaluechanged", onSegmentHit);

        await boardCharacteristic.startNotifications();
    }

    async function onSegmentHit(event) {
        const segmentID = new Uint8Array(event.target.value.buffer).join("-");
        const segment = SEGMENT_MAPPING[segmentID];

        if (segment) {
            console.log(segment)
        } else {
            console.log(`Unknown segment: ${segmentID}`);
        }
    }
</script>
</head>
<body>
<p>
<h3>Testing Dart Board Connection</h3>
</p>
<button onclick="connectToDartboard()">Connect to board</button>
<p>
</body>
</html>
