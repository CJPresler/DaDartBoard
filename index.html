<html>
<head>
<title>Da Dart Board</title>
<script>
    const GRANBOARD_UUID = "442f1570-8a00-9a28-cbe1-e1d4212d53eb";

    const SEGMENT_MAPPING = {
        // BUllsey
        "56-46-48-64": "BULL",
        "52-46-48-64": "BULL_DBL",
        // 1
        "56-46-51-64": "1_INNER",
        "56-46-51-64": "1_TRP",
        "56-46-52-64": "1_OUTER",
        "56-46-54-64": "1_DBL",
        // 2
        "57-46-49-64": "2_INNER",
        "57-46-48-64": "2_TRP",
        "57-46-50-64": "2_OUTER",
        "56-46-50-64": "2_DBL",
        // 3
        "55-46-49-64": "3_INNER",
        "55-46-48-64": "3_TRP",
        "55-46-50-64": "3_OUTER",
        "56-46-52-64": "3_DBL",
        // 4
        "48-46-49-64": "4_INNER",
        "48-46-51-64": "4_TRP",
        "48-46-53-64": "4_OUTER",
        "48-46-54-64": "4_DBL",
        // 5
        "53-46-49-64": "5_INNER",
        "53-46-50-64": "5_TRP",
        "53-46-52-64": "5_OUTER",
        "52-46-54-64": "5_DBL",
        // 6
        "49-46-48-64": "6_INNER",
        "49-46-49-64": "6_TRP",
        "49-46-51-64": "6_OUTER",
        "52-46-52-64": "6_DBL",

    }

    let boardCharacteristic = undefined;

    async function connectToDartboard() {
        if (boardCharacteristic) {
            // Unregister the previous listener
            boardCharacteristic.removeEventListener("characteristicvaluechanged", onSegmentHit);
        }

        const board = await navigator.bluetooth.requestDevice({filters:[{services: [GRANBOARD_UUID]}]});
        if (!board.gatt.connected) {
            await board.gatt.connect();
        }

        const service = await board.gatt.getPrimaryService(GRANBOARD_UUID);

        // Find the characteristic that supports the notify property. That is the one that executes when
        // a dartboard segment is hit
        boardCharacteristic = (await service.getCharacteristics()).find(characteristic => characteristic.properties.notify);

        boardCharacteristic.addEventListener("characteristicvaluechanged", onSegmentHit);

        await boardCharacteristic.startNotifications();
    }

    async function onSegmentHit(event)
    {
        let segmentID = new Uint8Array(event.target.value.buffer).join("-");
        
        console.log(segmentID);
    }
</script>
</head>
<body>
<p>
<h3>Testing Dart Board Connection</h3>
</p>
<button onclick="connectToDartboard()">Connect to board</button>
<p>
</body>
</html>
